<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Session Manager - Dark Pro</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
            background: #0a0a0b;
            background-image: 
                radial-gradient(circle at 20% 20%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 119, 198, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 119, 198, 0.15) 0%, transparent 50%);
            min-height: 100vh;
            color: #e1e5e9;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .header {
            background: rgba(18, 18, 20, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            max-width: none;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo h1 {
            font-size: 1.4rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo .icon {
            font-size: 1.8rem;
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .api-status.online {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .api-status.offline {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .main-content {
            padding: 20px 25px;
            width: 100%;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .stat-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .stat-card .icon {
            font-size: 1.8rem;
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .stat-card .number {
            font-size: 1.8rem;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 4px;
        }

        .stat-card .label {
            color: #94a3b8;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .controls-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            backdrop-filter: blur(20px);
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .control-group {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .control-group:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .control-group h3 {
            margin-bottom: 15px;
            color: #f1f5f9;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sessions-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 25px;
            backdrop-filter: blur(20px);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .sessions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 18px;
        }

        .session-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(15px);
        }

        .session-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .session-card:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-3px);
            border-color: rgba(255, 255, 255, 0.25);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .session-card.hibernated {
            background: rgba(251, 191, 36, 0.1);
            border-color: rgba(251, 191, 36, 0.3);
        }

        .session-card.hibernated::before {
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
        }

        .session-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 18px;
        }

        .profile-pic {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.2);
            object-fit: cover;
            transition: all 0.3s ease;
        }

        .profile-pic:hover {
            transform: scale(1.05);
            border-color: #667eea;
        }

        .session-info h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .session-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .session-status.connected {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .session-status.hibernated {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .session-status.disconnected {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .session-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 15px;
        }

        .session-buttons .btn:last-child {
            grid-column: span 2;
        }

        .btn {
            padding: 8px 14px;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            text-align: center;
            white-space: nowrap;
            border: 1px solid transparent;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-primary {
            background: rgba(59, 130, 246, 0.8);
            color: white;
            border-color: rgba(59, 130, 246, 0.5);
        }

        .btn-primary:hover {
            background: rgba(59, 130, 246, 1);
        }

        .btn-success {
            background: rgba(34, 197, 94, 0.8);
            color: white;
            border-color: rgba(34, 197, 94, 0.5);
        }

        .btn-success:hover {
            background: rgba(34, 197, 94, 1);
        }

        .btn-warning {
            background: rgba(251, 191, 36, 0.8);
            color: #1a1a1a;
            border-color: rgba(251, 191, 36, 0.5);
        }

        .btn-warning:hover {
            background: rgba(251, 191, 36, 1);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.8);
            color: white;
            border-color: rgba(239, 68, 68, 0.5);
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 1);
        }

        .btn-info {
            background: rgba(14, 165, 233, 0.8);
            color: white;
            border-color: rgba(14, 165, 233, 0.5);
        }

        .btn-info:hover {
            background: rgba(14, 165, 233, 1);
        }

        .btn-secondary {
            background: rgba(100, 116, 139, 0.8);
            color: white;
            border-color: rgba(100, 116, 139, 0.5);
        }

        .btn-secondary:hover {
            background: rgba(100, 116, 139, 1);
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .form-control {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
            color: #f1f5f9;
            min-width: 200px;
        }

        .form-control::placeholder {
            color: #94a3b8;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .global-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .result-box {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 250px;
            overflow-y: auto;
            font-size: 0.85rem;
        }

        .result-success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #22c55e;
        }

        .result-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: #1a1a1c;
            margin: 3% auto;
            padding: 0;
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px 25px;
            position: relative;
            flex-shrink: 0;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .close {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-50%) rotate(90deg);
        }

        .modal-body {
            padding: 25px;
            overflow-y: auto;
            flex: 1;
            background: #1a1a1c;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 18px;
            margin-bottom: 25px;
            padding: 18px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .profile-header img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .profile-info h3 {
            font-size: 1.3rem;
            color: #f1f5f9;
            margin-bottom: 5px;
        }

        .profile-info p {
            margin: 0;
            font-size: 0.95rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 3px solid #667eea;
            transition: all 0.3s ease;
        }

        .info-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(3px);
        }

        .info-item strong {
            color: #f1f5f9;
            font-weight: 600;
            flex-shrink: 0;
            min-width: 120px;
        }

        .info-item span {
            color: #94a3b8;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            text-align: right;
            word-break: break-all;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            text-align: center;
            color: #94a3b8;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #22c55e;
        }

        .status-indicator.hibernated {
            background: #fbbf24;
        }

        .status-indicator.disconnected {
            background: #ef4444;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-content {
                padding: 15px;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
                padding: 12px 15px;
            }

            .controls-grid {
                grid-template-columns: 1fr;
            }

            .sessions-grid {
                grid-template-columns: 1fr;
            }

            .session-buttons {
                grid-template-columns: 1fr;
            }

            .session-buttons .btn:last-child {
                grid-column: span 1;
            }

            .modal-content {
                margin: 5% auto;
                width: 95%;
                max-height: 95vh;
            }

            .profile-header {
                flex-direction: column;
                text-align: center;
            }

            .info-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .info-item span {
                text-align: left;
            }

            .input-group {
                flex-direction: column;
            }

            .form-control {
                min-width: auto;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .fade-in {
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #94a3b8;
        }

        .empty-state p {
            font-size: 1rem;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <span class="icon">üì±</span>
                <h1>WhatsApp Session Manager</h1>
            </div>
            <div class="api-status" id="apiStatus">
                <span class="status-indicator"></span>
                Verificando...
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Stats Dashboard -->
        <div class="stats-grid" id="statsGrid">
            <!-- Stats will be populated here -->
        </div>

        <!-- Controls Section -->
        <div class="controls-section">
            <h2 class="section-title">üéõÔ∏è Controles do Sistema</h2>
            <div class="controls-grid">
                <!-- Session Controls -->
                <div class="control-group">
                    <h3>üìù Criar Nova Sess√£o</h3>
                    <div class="input-group">
                        <input type="text" id="sessionIdInput" class="form-control" placeholder="Digite o ID da sess√£o">
                        <button class="btn btn-primary" onclick="createSession()">
                            ‚ûï Criar
                        </button>
                    </div>
                </div>

                <!-- QR Code -->
                <div class="control-group">
                    <h3>üì≤ Obter QR Code</h3>
                    <div class="input-group">
                        <input type="text" id="qrSessionIdInput" class="form-control" placeholder="ID da sess√£o para QR">
                        <button class="btn btn-info" onclick="getQRCodeManual()">
                            üîó QR Code
                        </button>
                    </div>
                </div>

                <!-- Send Message -->
                <div class="control-group">
                    <h3>üí¨ Enviar Mensagem</h3>
                    <div class="input-group">
                        <input type="text" id="messageSessionId" class="form-control" placeholder="ID da sess√£o">
                        <input type="text" id="messageNumber" class="form-control" placeholder="N√∫mero (ex: 555197756708 ou 555199999999@c.us)">
                    </div>
                    <div class="input-group">
                        <input type="text" id="messageText" class="form-control" placeholder="Sua mensagem">
                        <button class="btn btn-success" onclick="sendMessage()">
                            üì§ Enviar
                        </button>
                    </div>
                </div>

                <!-- Poll Management -->
                <div class="control-group">
                    <h3>üìä Gerenciar Enquetes (Polls)</h3>
                    <div class="input-group">
                        <input type="text" id="pollSessionId" class="form-control" placeholder="ID da sess√£o">
                        <input type="text" id="pollChatId" class="form-control" placeholder="Chat ID (ex: 555199999999@c.us)">
                    </div>
                    <div class="input-group">
                        <button class="btn btn-info" onclick="getChatPolls()">
                            üìã Listar Enquetes do Chat
                        </button>
                        <button class="btn btn-primary" onclick="showPollVotesModal()">
                            üó≥Ô∏è Ver Votos por ID
                        </button>
                    </div>
                    <div class="input-group">
                        <button class="btn btn-success" onclick="showCreatePollModal()">
                            ‚ûï Criar Enquete
                        </button>
                        <button class="btn btn-warning" onclick="showContactVotesModal()">
                            üë§ Votos por Contato
                        </button>
                    </div>
                </div>

                <!-- Global Controls -->
                <div class="control-group">
                    <h3>üåê Controles Globais</h3>
                    <div class="global-controls">
                        <button class="btn btn-warning" onclick="hibernateAllSessions()">
                            üò¥ Hibernar Todas
                        </button>
                        <button class="btn btn-success" onclick="reactivateAllSessions()">
                            üîã Reativar Todas
                        </button>
                        <button class="btn btn-danger" onclick="terminateInactive()">
                            üóëÔ∏è Limpar Inativas
                        </button>
                    </div>
                </div>

                <!-- View Once Management -->
                <div class="control-group">
                    <h3>üëÅÔ∏è Gerenciar M√≠dia View Once</h3>
                    <div class="input-group">
                        <input type="text" id="viewOnceSessionId" class="form-control" placeholder="ID da sess√£o">
                        <input type="text" id="viewOnceChatId" class="form-control" placeholder="Chat ID (ex: 555199999999@c.us)">
                    </div>
                    <div class="input-group">
                        <button class="btn btn-info" onclick="getViewOnceMedia()">
                            üìã Listar View Once
                        </button>
                        <button class="btn btn-primary" onclick="getViewOnceStats()">
                            üìä Estat√≠sticas
                        </button>
                    </div>
                    <div class="input-group">
                        <button class="btn btn-success" onclick="getChatsWithViewOnce()">
                            üí¨ Chats com View Once
                        </button>
                        <button class="btn btn-warning" onclick="showDownloadViewOnceModal()">
                            üíæ Baixar M√≠dia
                        </button>
                    </div>
                </div>
            </div>

            <!-- Result Box -->
            <div id="globalResult" class="result-box" style="display: none;"></div>
        </div>

        <!-- Sessions Section -->
        <div class="sessions-section">
            <div class="section-header">
                <h2 class="section-title">üìã Sess√µes Ativas</h2>
                <button class="btn btn-primary" onclick="loadSessions()">
                    üîÑ Atualizar Lista
                </button>
            </div>
            <div class="sessions-grid" id="sessionsContainer">
                <!-- Sessions will be populated here -->
            </div>
        </div>
    </div>

    <!-- Modal de Informa√ß√µes da Sess√£o -->
    <div id="sessionInfoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2>üì± Informa√ß√µes da Sess√£o</h2>
            </div>
            <div class="modal-body">
                <!-- Loading -->
                <div id="modalLoading" style="text-align: center; padding: 20px;">
                    <div class="spinner"></div>
                    <p class="loading-text">Carregando informa√ß√µes...</p>
                </div>
                
                <!-- Conte√∫do do Modal -->
                <div id="modalContent" style="display: none;">
                    <!-- Cabe√ßalho com foto e nome -->
                    <div class="profile-header">
                        <img id="modalProfileImg" src="" alt="Foto de Perfil" style="display: none;">
                        <div class="profile-info">
                            <h3 id="modalSessionTitle">Carregando...</h3>
                            <p id="modalSessionStatus">Verificando status...</p>
                        </div>
                    </div>
                    
                    <!-- Grid de informa√ß√µes -->
                    <div id="sessionInfoGrid" class="info-grid">
                        <!-- Informa√ß√µes ser√£o preenchidas via JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para Enquetes -->
        <div id="pollModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <span class="close" onclick="document.getElementById('pollModal').style.display='none'">&times;</span>
                    <h2 id="pollModalTitle">üìä Enquetes do Chat</h2>
                </div>
                
                <!-- Loading -->
                <div id="pollModalLoading" style="text-align: center; padding: 20px;">
                    <div class="loading-spinner"></div>
                    <p class="loading-text">Carregando enquetes...</p>
                </div>
                
                <!-- Conte√∫do das enquetes -->
                <div id="pollModalContent" style="display: none;">
                    <div id="pollsList">
                        <!-- Enquetes ser√£o preenchidas via JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para buscar votos por ID -->
        <div id="pollVotesModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <span class="close" onclick="document.getElementById('pollVotesModal').style.display='none'">&times;</span>
                    <h2>üó≥Ô∏è Buscar Votos da Enquete</h2>
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <input type="text" id="pollVoteSessionId" class="form-control" placeholder="ID da sess√£o">
                        <input type="text" id="pollVoteMessageId" class="form-control" placeholder="ID da mensagem da enquete">
                    </div>
                    <div class="input-group">
                        <button class="btn btn-primary" onclick="getPollVotes()">
                            üîç Buscar Votos
                        </button>
                    </div>
                    <div id="pollVotesResult" style="margin-top: 20px;">
                        <!-- Resultados ser√£o exibidos aqui -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para criar enquete -->
        <div id="createPollModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <span class="close" onclick="document.getElementById('createPollModal').style.display='none'">&times;</span>
                    <h2>‚ûï Criar Nova Enquete</h2>
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <input type="text" id="createPollSessionId" class="form-control" placeholder="ID da sess√£o">
                        <input type="text" id="createPollChatId" class="form-control" placeholder="Chat ID (ex: 555199999999@c.us)">
                    </div>
                    <div class="input-group">
                        <input type="text" id="createPollName" class="form-control" placeholder="Pergunta da enquete">
                    </div>
                    <div id="pollOptionsContainer">
                        <div class="input-group">
                            <input type="text" class="form-control poll-option" placeholder="Op√ß√£o 1">
                            <input type="text" class="form-control poll-option" placeholder="Op√ß√£o 2">
                        </div>
                    </div>
                    <div class="input-group">
                        <button type="button" class="btn btn-secondary" onclick="addPollOption()">+ Adicionar Op√ß√£o</button>
                        <label style="color: #94a3b8;">
                            <input type="checkbox" id="allowMultipleAnswers"> Permitir m√∫ltiplas respostas
                        </label>
                    </div>
                    <div class="input-group">
                        <button class="btn btn-success" onclick="createPoll()">
                            üìä Criar Enquete
                        </button>
                    </div>
                    <div id="createPollResult" style="margin-top: 20px;">
                        <!-- Resultado ser√° exibido aqui -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para buscar votos por contato -->
        <div id="contactVotesModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <span class="close" onclick="document.getElementById('contactVotesModal').style.display='none'">&times;</span>
                    <h2>üë§ Votos por Contato</h2>
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <input type="text" id="contactVotesSessionId" class="form-control" placeholder="ID da sess√£o">
                        <input type="text" id="contactVotesPhone" class="form-control" placeholder="N√∫mero do telefone (ex: 555199999999)">
                    </div>
                    <div class="input-group">
                        <input type="text" id="contactVotesChatId" class="form-control" placeholder="Chat ID (opcional - busca em todos se vazio)">
                        <button class="btn btn-primary" onclick="getContactVotes()">
                            üîç Buscar Votos
                        </button>
                    </div>
                    <div id="contactVotesResult" style="margin-top: 20px;">
                        <!-- Resultados ser√£o exibidos aqui -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para listar m√≠dia View Once -->
        <div id="viewOnceMediaModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <span class="close" onclick="document.getElementById('viewOnceMediaModal').style.display='none'">&times;</span>
                    <h2>üëÅÔ∏è M√≠dia View Once</h2>
                </div>
                <div class="modal-body">
                    <div id="viewOnceMediaResult">
                        <!-- Resultados ser√£o exibidos aqui -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para estat√≠sticas View Once -->
        <div id="viewOnceStatsModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <span class="close" onclick="document.getElementById('viewOnceStatsModal').style.display='none'">&times;</span>
                    <h2>üìä Estat√≠sticas View Once</h2>
                </div>
                <div class="modal-body">
                    <div id="viewOnceStatsResult">
                        <!-- Resultados ser√£o exibidos aqui -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para chats com View Once -->
        <div id="viewOnceChatsModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <span class="close" onclick="document.getElementById('viewOnceChatsModal').style.display='none'">&times;</span>
                    <h2>üí¨ Chats com View Once</h2>
                </div>
                <div class="modal-body">
                    <div id="viewOnceChatsResult">
                        <!-- Resultados ser√£o exibidos aqui -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para baixar m√≠dia View Once -->
        <div id="downloadViewOnceModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <span class="close" onclick="document.getElementById('downloadViewOnceModal').style.display='none'">&times;</span>
                    <h2>üíæ Baixar M√≠dia View Once</h2>
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <input type="text" id="downloadViewOnceSessionId" class="form-control" placeholder="ID da sess√£o">
                        <input type="text" id="downloadViewOnceChatId" class="form-control" placeholder="Chat ID">
                    </div>
                    <div class="input-group">
                        <input type="text" id="downloadViewOnceMessageId" class="form-control" placeholder="ID da mensagem View Once">
                        <label style="color: #94a3b8;">
                            <input type="checkbox" id="forceDownload"> For√ßar download (mesmo se expirado)
                        </label>
                    </div>
                    <div class="input-group">
                        <button class="btn btn-primary" onclick="downloadViewOnceMedia()">
                            üíæ Baixar M√≠dia
                        </button>
                    </div>
                    <div id="downloadViewOnceResult" style="margin-top: 20px;">
                        <!-- Resultado ser√° exibido aqui -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para exibir votos detalhados de uma enquete -->
    <div id="pollVotesDetailModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>üó≥Ô∏è Votos Detalhados da Enquete</h2>
                <span class="close" onclick="document.getElementById('pollVotesDetailModal').style.display='none'">&times;</span>
            </div>
            <div class="modal-body">
                <div id="pollVotesDetailContainer">
                    <!-- Votos detalhados ser√£o exibidos aqui -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:200';
        const API_KEY = 'redblack';
        let currentSessionForQR = null;

        // =====================================
        // FUN√á√ïES PARA GERENCIAR ENQUETES
        // =====================================

        // Mostrar modal para criar enquete
        function showCreatePollModal() {
            document.getElementById('createPollModal').style.display = 'block';
        }

        // Mostrar modal para buscar votos por ID
        function showPollVotesModal() {
            document.getElementById('pollVotesModal').style.display = 'block';
        }

        // Mostrar modal para buscar votos por contato
        function showContactVotesModal() {
            document.getElementById('contactVotesModal').style.display = 'block';
        }

        // Adicionar nova op√ß√£o na cria√ß√£o de enquete
        function addPollOption() {
            const container = document.getElementById('pollOptionsContainer');
            const currentOptions = container.querySelectorAll('.poll-option').length;
            
            if (currentOptions >= 12) {
                alert('M√°ximo de 12 op√ß√µes permitidas');
                return;
            }
            
            const newGroup = document.createElement('div');
            newGroup.className = 'input-group';
            newGroup.innerHTML = `
                <input type="text" class="form-control poll-option" placeholder="Op√ß√£o ${currentOptions + 1}">
                <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()">√ó</button>
            `;
            container.appendChild(newGroup);
        }

        // Criar enquete usando endpoint sendMessage
        async function createPoll() {
            const sessionId = document.getElementById('createPollSessionId').value.trim();
            const chatId = document.getElementById('createPollChatId').value.trim();
            const pollName = document.getElementById('createPollName').value.trim();
            const allowMultipleAnswers = document.getElementById('allowMultipleAnswers').checked;
            
            if (!sessionId || !chatId || !pollName) {
                alert('Por favor, preencha Session ID, Chat ID e a pergunta da enquete');
                return;
            }

            // Formatar chatId se necess√°rio
            let formattedChatId = chatId;
            if (!chatId.includes('@')) {
                formattedChatId = chatId + '@c.us';
            }

            // Coletar op√ß√µes
            const pollOptions = [];
            const optionInputs = document.querySelectorAll('.poll-option');
            
            optionInputs.forEach(input => {
                const value = input.value.trim();
                if (value) {
                    pollOptions.push(value);
                }
            });

            if (pollOptions.length < 2) {
                alert('A enquete deve ter pelo menos 2 op√ß√µes');
                return;
            }

            try {
                // Usar endpoint sendMessage com contentType Poll
                const result = await apiRequest(`/client/sendMessage/${sessionId}`, 'POST', {
                    chatId: formattedChatId,
                    contentType: 'Poll',
                    content: {
                        pollName: pollName,
                        pollOptions: pollOptions,
                        options: {
                            allowMultipleAnswers: allowMultipleAnswers
                        }
                    }
                });
                
                const resultDiv = document.getElementById('createPollResult');
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div style="color: #10b981; padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                            ‚úÖ Enquete criada com sucesso!<br>
                            <small>ID da mensagem: ${result.data && result.data.id ? result.data.id._serialized || result.data.id : 'N/A'}</small>
                        </div>
                    `;
                    
                    // Limpar formul√°rio
                    document.getElementById('createPollSessionId').value = '';
                    document.getElementById('createPollChatId').value = '';
                    document.getElementById('createPollName').value = '';
                    document.getElementById('allowMultipleAnswers').checked = false;
                    
                    // Resetar op√ß√µes para apenas 2
                    const container = document.getElementById('pollOptionsContainer');
                    container.innerHTML = `
                        <div class="input-group">
                            <input type="text" class="form-control poll-option" placeholder="Op√ß√£o 1">
                            <input type="text" class="form-control poll-option" placeholder="Op√ß√£o 2">
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div style="color: #ef4444; padding: 15px; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                            ‚ùå Erro ao criar enquete: ${result.error}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao criar enquete:', error);
                document.getElementById('createPollResult').innerHTML = `
                    <div style="color: #ef4444; padding: 15px; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                        ‚ùå Erro ao criar enquete: ${error.message}
                    </div>
                `;
            }
        }

        // Obter enquetes de um chat
        async function getChatPolls() {
            const sessionId = document.getElementById('pollSessionId').value.trim();
            const chatId = document.getElementById('pollChatId').value.trim();
            
            if (!sessionId || !chatId) {
                alert('Por favor, preencha o ID da sess√£o e o Chat ID');
                return;
            }

            // Formatar chatId se necess√°rio
            let formattedChatId = chatId;
            if (!chatId.includes('@')) {
                formattedChatId = chatId + '@c.us';
            }

            try {
                // Mostrar modal e loading
                const modal = document.getElementById('pollModal');
                const modalLoading = document.getElementById('pollModalLoading');
                const modalContent = document.getElementById('pollModalContent');
                
                modal.style.display = 'block';
                modalLoading.style.display = 'block';
                modalContent.style.display = 'none';
                
                // Fazer requisi√ß√£o
                const result = await apiRequest(`/poll/getChatPolls/${sessionId}`, 'POST', {
                    chatId: formattedChatId,
                    limit: 50
                });
                
                if (result.success) {
                    displayChatPolls(result.data.polls, formattedChatId);
                    modalLoading.style.display = 'none';
                    modalContent.style.display = 'block';
                } else {
                    alert(`‚ùå Erro ao obter enquetes: ${result.error}`);
                    modal.style.display = 'none';
                }
            } catch (error) {
                console.error('Erro ao obter enquetes:', error);
                alert(`‚ùå Erro ao obter enquetes: ${error.message}`);
                document.getElementById('pollModal').style.display = 'none';
            }
        }

        // Obter votos de contato
        async function getContactVotes() {
            const sessionId = document.getElementById('contactVotesSessionId').value.trim();
            const phoneNumber = document.getElementById('contactVotesPhone').value.trim();
            const chatId = document.getElementById('contactVotesChatId').value.trim();
            
            if (!sessionId || !phoneNumber) {
                alert('Por favor, preencha o ID da sess√£o e o n√∫mero do telefone');
                return;
            }

            try {
                const requestBody = {
                    phoneNumber: phoneNumber,
                    limit: 100
                };
                
                if (chatId) {
                    // Formatar chatId se necess√°rio
                    requestBody.chatId = chatId.includes('@') ? chatId : chatId + '@c.us';
                }

                const result = await apiRequest(`/poll/getVotesByContact/${sessionId}`, 'POST', requestBody);
                
                const resultDiv = document.getElementById('contactVotesResult');
                
                if (result.success) {
                    const responseData = result.data;
                    const votes = responseData.votes || [];
                    
                    if (votes.length === 0) {
                        resultDiv.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: #94a3b8;">
                                üì≠ Nenhum voto encontrado para este contato
                            </div>
                        `;
                        return;
                    }

                    const votesHtml = votes.map(vote => `
                        <div style="margin: 15px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <div style="font-weight: bold; color: #60a5fa; margin-bottom: 8px;">
                                üó≥Ô∏è ${vote.pollName}
                            </div>
                            <div style="color: #10b981; margin-bottom: 5px;">
                                ‚úÖ Votou em: <strong>${vote.selectedOption}</strong>
                            </div>
                            <div style="color: #94a3b8; font-size: 0.9rem;">
                                üìÖ ${new Date(vote.timestamp * 1000).toLocaleString()}<br>
                                üí¨ Chat: ${vote.chatName}<br>
                                üÜî Mensagem: <code style="background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 4px;">${vote.messageId}</code>
                            </div>
                        </div>
                    `).join('');
                    
                    resultDiv.innerHTML = `
                        <div style="background: #1a1a1c; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); padding: 20px;">
                            <h4 style="color: #fff; margin-bottom: 15px;">
                                üë§ Votos de ${responseData.contact || phoneNumber} (Total: ${responseData.totalVotes || votes.length})
                            </h4>
                            <div style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 15px;">
                                Pesquisado em ${responseData.searchedChats || 'N/A'} chat(s)
                            </div>
                            ${votesHtml}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div style="color: #ef4444; padding: 15px; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                            ‚ùå Erro: ${result.error}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao obter votos do contato:', error);
                document.getElementById('contactVotesResult').innerHTML = `
                    <div style="color: #ef4444; padding: 15px; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                        ‚ùå Erro: ${error.message}
                    </div>
                `;
            }
        }

        // Fun√ß√£o para fazer requisi√ß√µes √† API
        async function apiRequest(endpoint, method = 'GET', body = null) {
            try {
                const options = {
                    method,
                    headers: {
                        'accept': 'application/json',
                        'x-api-key': API_KEY
                    }
                };

                if (body) {
                    options.headers['Content-Type'] = 'application/json';
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const data = await response.json();

                return {
                    success: response.ok,
                    data: data,
                    error: response.ok ? null : (data.message || `HTTP ${response.status}`)
                };
            } catch (error) {
                return {
                    success: false,
                    data: null,
                    error: error.message
                };
            }
        }

        // Exibir enquetes do chat no modal
        function displayChatPolls(polls, chatId) {
            const container = document.getElementById('pollsContainer');
            
            if (!polls || polls.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #94a3b8;">
                        üì≠ Nenhuma enquete encontrada neste chat
                    </div>
                `;
                return;
            }

            const pollsHtml = polls.map(poll => {
                const totalVotes = poll.votes.reduce((sum, option) => sum + option.count, 0);
                
                const optionsHtml = poll.votes.map(option => {
                    const percentage = totalVotes > 0 ? Math.round((option.count / totalVotes) * 100) : 0;
                    return `
                        <div style="margin: 8px 0; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <span style="color: #e2e8f0;">${option.name}</span>
                                <span style="color: #60a5fa; font-weight: bold;">${option.count} voto(s)</span>
                            </div>
                            <div style="width: 100%; background: rgba(255,255,255,0.1); border-radius: 10px; height: 6px;">
                                <div style="width: ${percentage}%; background: linear-gradient(90deg, #3b82f6, #60a5fa); height: 100%; border-radius: 10px; transition: width 0.3s ease;"></div>
                            </div>
                            <div style="color: #94a3b8; font-size: 0.8rem; margin-top: 2px;">${percentage}%</div>
                        </div>
                    `;
                }).join('');

                return `
                    <div style="margin: 20px 0; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="color: #fff; margin: 0; flex: 1;">üó≥Ô∏è ${poll.name}</h4>
                            <button onclick="getPollVotes('${poll.id}')" style="background: #3b82f6; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                                Ver Votos
                            </button>
                        </div>
                        <div style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 15px;">
                            üìä Total de votos: <strong style="color: #60a5fa;">${totalVotes}</strong> | 
                            üìÖ ${new Date(poll.timestamp * 1000).toLocaleString()} | 
                            üÜî <code style="background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 4px;">${poll.id}</code>
                        </div>
                        <div style="margin-top: 15px;">
                            ${optionsHtml}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div style="background: #1a1a1c; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); padding: 20px;">
                    <h3 style="color: #fff; margin-bottom: 15px;">üìä Enquetes do Chat</h3>
                    <div style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 20px;">
                        üí¨ Chat: <code style="background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 4px;">${chatId}</code><br>
                        üìà Total de enquetes: ${polls.length}
                    </div>
                    ${pollsHtml}
                </div>
            `;
        }

        // Obter votos detalhados de uma enquete
        async function getPollVotes(pollId) {
            const sessionId = document.getElementById('pollSessionId').value.trim();
            
            if (!sessionId) {
                alert('Session ID n√£o informado');
                return;
            }

            try {
                const result = await apiRequest(`/poll/getVotes/${sessionId}`, 'POST', {
                    pollId: pollId
                });
                
                if (result.success) {
                    displayPollVotes(result.data.votes, result.data.pollName, pollId);
                } else {
                    alert(`‚ùå Erro ao obter votos: ${result.error}`);
                }
            } catch (error) {
                console.error('Erro ao obter votos da enquete:', error);
                alert(`‚ùå Erro ao obter votos: ${error.message}`);
            }
        }

        // Exibir votos detalhados no modal
        function displayPollVotes(votes, pollName, pollId) {
            const modal = document.getElementById('pollVotesDetailModal');
            const container = document.getElementById('pollVotesDetailContainer');
            
            if (!votes || votes.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #94a3b8;">
                        üì≠ Nenhum voto encontrado para esta enquete
                    </div>
                `;
                modal.style.display = 'block';
                return;
            }

            const votesHtml = votes.map(vote => `
                <div style="margin: 15px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-weight: bold; color: #60a5fa;">
                            üë§ ${vote.voterName}
                        </div>
                        <div style="color: #94a3b8; font-size: 0.9rem;">
                            üì± ${vote.voterPhone}
                        </div>
                    </div>
                    <div style="color: #10b981; margin-bottom: 5px;">
                        ‚úÖ Escolha: <strong>${vote.selectedOption}</strong>
                    </div>
                    <div style="color: #94a3b8; font-size: 0.85rem;">
                        üìÖ ${new Date(vote.timestamp * 1000).toLocaleString()}
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = `
                <div style="background: #1a1a1c; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); padding: 20px;">
                    <h3 style="color: #fff; margin-bottom: 15px;">üó≥Ô∏è ${pollName}</h3>
                    <div style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 20px;">
                        üÜî Poll ID: <code style="background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 4px;">${pollId}</code><br>
                        üë• Total de votos: ${votes.length}
                    </div>
                    ${votesHtml}
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // Verificar status da API
        async function checkApiStatus() {
            const result = await apiRequest('/health');
            const statusElement = document.getElementById('apiStatus');
            
            if (result.success) {
                statusElement.className = 'api-status online';
                statusElement.innerHTML = '<span class="status-indicator connected"></span>API Online';
            } else {
                statusElement.className = 'api-status offline';
                statusElement.innerHTML = '<span class="status-indicator disconnected"></span>API Offline';
            }
        }

        // Atualizar estat√≠sticas do dashboard
        async function updateStats() {
            const result = await apiRequest('/session/list');
            if (!result.success) return;

            // Verificar se result.data.sessions existe, sen√£o usar result.data
            const sessions = Array.isArray(result.data.sessions) ? result.data.sessions : 
                           Array.isArray(result.data) ? result.data : [];
            const connected = sessions.filter(s => s.status === 'CONNECTED').length;
            const hibernated = sessions.filter(s => s.status === 'HIBERNATED').length;
            const disconnected = sessions.filter(s => s.status === 'DISCONNECTED').length;
            const total = sessions.length;

            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="icon">üìä</div>
                    <div class="number">${total}</div>
                    <div class="label">Total de Sess√µes</div>
                </div>
                <div class="stat-card">
                    <div class="icon">‚úÖ</div>
                    <div class="number">${connected}</div>
                    <div class="label">Conectadas</div>
                </div>
                <div class="stat-card">
                    <div class="icon">üò¥</div>
                    <div class="number">${hibernated}</div>
                    <div class="label">Hibernadas</div>
                </div>
                <div class="stat-card">
                    <div class="icon">‚ùå</div>
                    <div class="number">${disconnected}</div>
                    <div class="label">Desconectadas</div>
                </div>
            `;
        }

        // Carregar lista de sess√µes
        async function loadSessions() {
            const result = await apiRequest('/session/list');
            const container = document.getElementById('sessionsContainer');
            
            // Debug: log da resposta da API
            console.log('API Response:', result);
            
            if (!result.success) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚ùå</div>
                        <h3>Erro ao carregar sess√µes</h3>
                        <p>${result.error}</p>
                    </div>
                `;
                return;
            }

            // Verificar se result.data.sessions existe, sen√£o usar result.data
            const sessions = Array.isArray(result.data.sessions) ? result.data.sessions : 
                           Array.isArray(result.data) ? result.data : [];
            
            console.log('Sessions:', sessions);
            
            if (sessions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üì±</div>
                        <h3>Nenhuma sess√£o encontrada</h3>
                        <p>Crie uma nova sess√£o para come√ßar</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = sessions.map(session => {
                const isConnected = session.status === 'CONNECTED';
                const isHibernated = session.status === 'HIBERNATED';
                const statusClass = isConnected ? 'connected' : (isHibernated ? 'hibernated' : 'disconnected');
                const statusText = isConnected ? 'Conectado' : (isHibernated ? 'Hibernada' : 'Desconectado');
                
                return `
                    <div class="session-card ${isHibernated ? 'hibernated' : ''} fade-in">
                        <div class="session-header">
                            ${session.profilePicUrl && session.profilePicUrl.startsWith('http') ? `
                                <img src="${session.profilePicUrl}" alt="Foto de Perfil" class="profile-pic" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="profile-pic" style="background: linear-gradient(135deg, #667eea, #764ba2); display: none; align-items: center; justify-content: center; color: white; font-size: 1.2rem;">
                                    üë§
                                </div>
                            ` : `
                                <div class="profile-pic" style="background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;">
                                    üë§
                                </div>
                            `}
                            <div class="session-info">
                                <h3>${session.pushName || session.sessionId}</h3>
                                <div class="session-status ${statusClass}">
                                    <span class="status-indicator ${statusClass}"></span>
                                    ${statusText}
                                </div>
                            </div>
                        </div>
                        
                        <div class="session-buttons">
                            ${isHibernated ? `
                                <button class="btn btn-success" onclick="reactivateSession('${session.sessionId}')">
                                    üîã Reativar
                                </button>
                            ` : `
                                <button class="btn btn-primary" onclick="getQRCode('${session.sessionId}')" ${isConnected ? 'disabled' : ''}>
                                    üì± QR Code
                                </button>
                                <button class="btn btn-warning" onclick="hibernateSession('${session.sessionId}')">
                                    üò¥ Hibernar
                                </button>
                            `}
                            <button class="btn btn-info" onclick="showSessionInfo('${session.sessionId}')">
                                ‚ÑπÔ∏è Info
                            </button>
                            <button class="btn btn-secondary" onclick="checkSessionStatus('${session.sessionId}')">
                                üìä Status
                            </button>
                            <button class="btn btn-danger" onclick="terminateSession('${session.sessionId}')">
                                üõë Terminar
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // Atualizar estat√≠sticas tamb√©m
            updateStats();
        }

        // Criar nova sess√£o
        async function createSession() {
            const sessionId = document.getElementById('sessionIdInput').value.trim();
            if (!sessionId) {
                alert('Por favor, digite um ID para a sess√£o');
                return;
            }

            const result = await apiRequest(`/session/start/${sessionId}`, 'GET');
            
            if (result.success) {
                alert('‚úÖ Sess√£o criada com sucesso!');
                document.getElementById('sessionIdInput').value = '';
                loadSessions();
            } else {
                alert(`‚ùå Erro ao criar sess√£o: ${result.error}`);
            }
        }

        // Obter QR Code
        async function getQRCode(sessionId) {
            currentSessionForQR = sessionId;
            
            try {
                // Usar endpoint de imagem para QR Code
                const qrImageUrl = `${API_BASE}/session/qr/${sessionId}/image`;
                console.log('QR Image URL:', qrImageUrl);
                
                // Fazer fetch da imagem com headers de autentica√ß√£o
                const response = await fetch(qrImageUrl, {
                    method: 'GET',
                    headers: {
                        'x-api-key': API_KEY,
                        'accept': 'image/png'
                    }
                });
                
                console.log('QR Response status:', response.status);
                
                if (response.ok) {
                    // Verificar se URL.createObjectURL est√° dispon√≠vel
                    if (typeof URL !== 'undefined' && URL.createObjectURL) {
                        // Converter resposta para blob e criar URL local
                        const blob = await response.blob();
                        const blobUrl = URL.createObjectURL(blob);
                        
                        console.log('QR Blob URL created:', blobUrl);
                        console.log('Showing QR modal for:', sessionId);
                        
                        // Criar modal para mostrar QR
                        showQRModal(blobUrl, sessionId);
                    } else {
                        // Fallback: usar URL direta com headers
                        console.log('URL.createObjectURL n√£o dispon√≠vel, usando URL direta');
                        showQRModal(qrImageUrl, sessionId);
                    }
                } else {
                    alert(`‚ùå Erro ao obter QR Code: QR n√£o dispon√≠vel (Status: ${response.status})`);
                }
            } catch (error) {
                console.error('Erro ao obter QR Code:', error);
                alert(`‚ùå Erro ao obter QR Code: ${error.message}`);
            }
        }

        function showQRModal(qrUrl, sessionId) {
            console.log('showQRModal called with:', qrUrl, sessionId);
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '9999'; // Z-index mais alto para garantir que apare√ßa na frente
            
            // Fun√ß√£o para fechar o modal e limpar recursos
            const closeModal = () => {
                try {
                    // S√≥ tentar revogar se for uma URL blob e se URL.revokeObjectURL existir
                    if (qrUrl && qrUrl.startsWith('blob:') && typeof URL !== 'undefined' && URL.revokeObjectURL) {
                        URL.revokeObjectURL(qrUrl);
                        console.log('Blob URL revogada com sucesso');
                    }
                } catch (error) {
                    console.log('Erro ao revogar URL do blob:', error);
                }
                modal.remove();
            };
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px; text-align: center; margin: 10% auto; background: #1a1a1c; border-radius: 16px; padding: 20px;">
                    <div class="modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 20px;">
                        <span class="close" style="float: right; font-size: 28px; color: #aaa; cursor: pointer;">&times;</span>
                        <h2 style="color: #fff; margin: 0;">üì± QR Code - ${sessionId}</h2>
                    </div>
                    <div class="modal-body">
                        <p style="color: #94a3b8; margin-bottom: 20px;">Escaneie este QR Code com o WhatsApp:</p>
                        <img src="${qrUrl}" alt="QR Code" style="width: 100%; max-width: 300px; border-radius: 10px; border: 2px solid rgba(255,255,255,0.1);" 
                             onerror="console.log('Erro ao carregar imagem QR:', this.src); this.style.display='none'; this.nextElementSibling.style.display='block';"
                             onload="console.log('QR Image loaded successfully');">
                        <div style="display: none; padding: 20px; color: #ef4444; background: rgba(239, 68, 68, 0.1); border-radius: 8px; margin: 10px 0;">
                            ‚ùå Erro ao carregar QR Code. Tente novamente.
                        </div>
                        <p style="margin-top: 15px; color: #64748b; font-size: 0.9rem;">
                            Abra o WhatsApp > Dispositivos conectados > Conectar um dispositivo
                        </p>
                    </div>
                </div>
            `;
            
            // Adicionar event listener para fechar
            const closeBtn = modal.querySelector('.close');
            closeBtn.addEventListener('click', closeModal);
            
            // Fechar ao clicar fora do modal
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });
            
            console.log('Appending modal to body');
            document.body.appendChild(modal);
            console.log('Modal appended, checking visibility...');
            console.log('Modal display style:', modal.style.display);
            console.log('Modal in DOM:', document.body.contains(modal));
        }

        // Obter QR Code manual
        async function getQRCodeManual() {
            const sessionId = document.getElementById('qrSessionIdInput').value.trim();
            if (!sessionId) {
                alert('Por favor, digite o ID da sess√£o');
                return;
            }
            
            await getQRCode(sessionId);
            document.getElementById('qrSessionIdInput').value = '';
        }

        // Enviar mensagem
        async function sendMessage() {
            const sessionId = document.getElementById('messageSessionId').value.trim();
            const number = document.getElementById('messageNumber').value.trim();
            const message = document.getElementById('messageText').value.trim();
            
            if (!sessionId || !number || !message) {
                alert('Por favor, preencha todos os campos');
                return;
            }

            // Formatear n√∫mero para o formato correto se necess√°rio
            let chatId = number;
            if (!chatId.includes('@')) {
                chatId = chatId + '@c.us';
            }

            const result = await apiRequest(`/client/sendMessage/${sessionId}`, 'POST', {
                chatId: chatId,
                contentType: "string",
                content: message
            });
            
            if (result.success) {
                alert('‚úÖ Mensagem enviada com sucesso!');
                document.getElementById('messageSessionId').value = '';
                document.getElementById('messageNumber').value = '';
                document.getElementById('messageText').value = '';
            } else {
                alert(`‚ùå Erro ao enviar mensagem: ${result.error}`);
            }
        }

        // Verificar status da sess√£o
        async function checkSessionStatus(sessionId) {
            const result = await apiRequest(`/session/status/${sessionId}`);
            
            if (result.success) {
                alert(`üìä Status da sess√£o ${sessionId}:\n\n${JSON.stringify(result.data, null, 2)}`);
            } else {
                alert(`‚ùå Erro ao verificar status: ${result.error}`);
            }
        }

        // Terminar sess√£o
        async function terminateSession(sessionId) {
            if (!confirm(`‚ö†Ô∏è Tem certeza que deseja terminar a sess√£o "${sessionId}"?`)) {
                return;
            }

            const result = await apiRequest(`/session/terminate/${sessionId}`, 'GET');
            
            if (result.success) {
                alert('‚úÖ Sess√£o terminada com sucesso!');
                loadSessions();
            } else {
                alert(`‚ùå Erro ao terminar sess√£o: ${result.error}`);
            }
        }

        // Hibernar sess√£o
        async function hibernateSession(sessionId) {
            try {
                const result = await apiRequest(`/session/hibernate/${sessionId}`, 'GET');
                
                if (result.success) {
                    alert(`‚úÖ Sess√£o "${sessionId}" hibernada com sucesso!\n\nA sess√£o foi pausada mas mant√©m a conex√£o com o WhatsApp.`);
                    loadSessions();
                } else {
                    alert('‚ùå Erro ao hibernar sess√£o: ' + (result.error || (result.data && result.data.message) || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao hibernar sess√£o:', error);
                alert('‚ùå Erro ao hibernar sess√£o: ' + error.message);
            }
        }

        // Reativar sess√£o
        async function reactivateSession(sessionId) {
            try {
                const result = await apiRequest(`/session/reactivate/${sessionId}`, 'GET');
                
                if (result.success) {
                    alert(`‚úÖ Sess√£o "${sessionId}" reativada com sucesso!\n\nA sess√£o voltou ao estado ativo.`);
                    loadSessions();
                } else {
                    alert('‚ùå Erro ao reativar sess√£o: ' + (result.error || (result.data && result.data.message) || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao reativar sess√£o:', error);
                alert('‚ùå Erro ao reativar sess√£o: ' + error.message);
            }
        }

        // Hibernar todas as sess√µes
        async function hibernateAllSessions() {
            if (!confirm('‚ö†Ô∏è Tem certeza que deseja hibernar TODAS as sess√µes ativas?\n\nEsta a√ß√£o √© ideal para manuten√ß√£o do sistema.')) {
                return;
            }

            const result = await apiRequest('/session/hibernateAll', 'GET');
            const resultDiv = document.getElementById('globalResult');
            
            resultDiv.style.display = 'block';
            
            if (result.success) {
                resultDiv.className = 'result-box result-success';
                resultDiv.textContent = `‚úÖ ${result.data.hibernatedCount} sess√µes hibernadas com sucesso!\n\n` + JSON.stringify(result.data, null, 2);
            } else {
                resultDiv.className = 'result-box result-error';
                resultDiv.textContent = `‚ùå Erro: ${result.error || 'Falha na requisi√ß√£o'}`;
            }
            
            loadSessions();
        }

        // Reativar todas as sess√µes hibernadas
        async function reactivateAllSessions() {
            if (!confirm('‚ö†Ô∏è Tem certeza que deseja reativar TODAS as sess√µes hibernadas?')) {
                return;
            }

            const result = await apiRequest('/session/reactivateAll', 'GET');
            const resultDiv = document.getElementById('globalResult');
            
            resultDiv.style.display = 'block';
            
            if (result.success) {
                resultDiv.className = 'result-box result-success';
                resultDiv.textContent = `‚úÖ ${result.data.reactivatedCount} sess√µes reativadas com sucesso!\n\n` + JSON.stringify(result.data, null, 2);
            } else {
                resultDiv.className = 'result-box result-error';
                resultDiv.textContent = `‚ùå Erro: ${result.error || 'Falha na requisi√ß√£o'}`;
            }
            
            loadSessions();
        }

        // Terminar sess√µes inativas
        async function terminateInactive() {
            if (!confirm('‚ö†Ô∏è Tem certeza que deseja terminar todas as sess√µes inativas?')) {
                return;
            }

            const result = await apiRequest('/session/terminateInactive', 'GET');
            const resultDiv = document.getElementById('globalResult');
            
            resultDiv.style.display = 'block';
            
            if (result.success) {
                resultDiv.className = 'result-box result-success';
                resultDiv.textContent = `‚úÖ ${result.data.terminatedCount} sess√µes inativas terminadas!\n\n` + JSON.stringify(result.data, null, 2);
            } else {
                resultDiv.className = 'result-box result-error';
                resultDiv.textContent = `‚ùå Erro: ${result.error || 'Falha na requisi√ß√£o'}`;
            }
            
            loadSessions();
        }

        // Fun√ß√£o para exibir informa√ß√µes detalhadas da sess√£o
        async function showSessionInfo(sessionId) {
            try {
                const modal = document.getElementById('sessionInfoModal');
                const modalContent = document.getElementById('modalContent');
                const modalLoading = document.getElementById('modalLoading');
                
                // Verificar se os elementos existem
                if (!modal || !modalContent || !modalLoading) {
                    console.error('Elementos do modal n√£o encontrados');
                    alert('‚ùå Erro: Modal n√£o encontrado. Recarregue a p√°gina.');
                    return;
                }
                
                // Mostrar o modal
                modal.style.display = 'block';
                
                // Mostrar loading
                modalContent.style.display = 'none';
                modalLoading.style.display = 'block';
                
                // Buscar informa√ß√µes detalhadas da sess√£o usando o endpoint correto
                const response = await fetch(`${API_BASE}/client/${sessionId}/getClassInfo`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': API_KEY
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Erro ao buscar informa√ß√µes: ${response.status}`);
                }
                
                const sessionData = await response.json();
                
                console.log('Session Info Response:', sessionData);
                
                // Preencher o modal com as informa√ß√µes
                populateSessionModal(sessionId, sessionData);
                
                // Ocultar loading e mostrar conte√∫do
                modalLoading.style.display = 'none';
                modalContent.style.display = 'block';
                
            } catch (error) {
                console.error('Erro ao buscar informa√ß√µes da sess√£o:', error);
                alert(`‚ùå Erro ao buscar informa√ß√µes da sess√£o: ${error.message}`);
                closeModal();
            }
        }
        
        // Fun√ß√£o para preencher o modal com informa√ß√µes da sess√£o
        function populateSessionModal(sessionId, response) {
            // Atualizar cabe√ßalho do modal
            const profileImg = document.getElementById('modalProfileImg');
            const sessionTitle = document.getElementById('modalSessionTitle');
            const sessionStatus = document.getElementById('modalSessionStatus');
            
            // Verificar se os elementos existem antes de manipul√°-los
            if (!profileImg || !sessionTitle || !sessionStatus) {
                console.error('Elementos do modal n√£o encontrados');
                return;
            }

            // Extrair sessionInfo da resposta
            const sessionInfo = response.sessionInfo || response;
            
            // Usar foto de perfil se dispon√≠vel
            if (sessionInfo.profilePicUrl) {
                profileImg.src = sessionInfo.profilePicUrl;
                profileImg.style.display = 'block';
            } else {
                profileImg.style.display = 'none';
            }
            
            sessionTitle.textContent = sessionInfo.pushname || sessionInfo.wid?.user || sessionId;
            
            // Status da sess√£o (assumir conectado se h√° sessionInfo)
            const isConnected = response.success && sessionInfo;
            const statusColor = isConnected ? '#22c55e' : '#ef4444';
            sessionStatus.innerHTML = `<span style="color: ${statusColor};">‚óè ${isConnected ? 'Conectado' : 'Desconectado'}</span>`;
            
            // Preencher informa√ß√µes detalhadas
            const infoGrid = document.getElementById('sessionInfoGrid');
            if (!infoGrid) {
                console.error('Grid de informa√ß√µes n√£o encontrado');
                return;
            }
            
            infoGrid.innerHTML = `
                <div class="info-item">
                    <strong>Session ID:</strong>
                    <span>${sessionId}</span>
                </div>
                <div class="info-item">
                    <strong>Nome:</strong>
                    <span>${sessionInfo.pushname || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <strong>WhatsApp ID:</strong>
                    <span>${sessionInfo.wid?.user || sessionInfo.me?.user || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <strong>Servidor:</strong>
                    <span>${sessionInfo.wid?.server || sessionInfo.me?.server || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <strong>Status:</strong>
                    <span style="color: ${statusColor};">${isConnected ? 'Conectado' : 'Desconectado'}</span>
                </div>
                <div class="info-item">
                    <strong>Plataforma:</strong>
                    <span>${sessionInfo.platform || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <strong>WhatsApp Serialized:</strong>
                    <span>${sessionInfo.wid?._serialized || sessionInfo.me?._serialized || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <strong>Tipo de Conta:</strong>
                    <span>${sessionInfo.platform === 'smba' ? 'Business' : 'Pessoal'}</span>
                </div>
            `;
        }
        
        // Fun√ß√£o para fechar o modal
        function closeModal() {
            const modal = document.getElementById('sessionInfoModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // =====================================
        // FUN√á√ïES PARA GERENCIAR ENQUETES
        // =====================================

        // Obter enquetes de um chat
        async function getChatPolls() {
            const sessionId = document.getElementById('pollSessionId').value.trim();
            const chatId = document.getElementById('pollChatId').value.trim();
            
            if (!sessionId || !chatId) {
                alert('Por favor, preencha o ID da sess√£o e o Chat ID');
                return;
            }

            // Formatar chatId se necess√°rio
            let formattedChatId = chatId;
            if (!chatId.includes('@')) {
                formattedChatId = chatId + '@c.us';
            }

            try {
                // Mostrar modal e loading
                const modal = document.getElementById('pollModal');
                const modalLoading = document.getElementById('pollModalLoading');
                const modalContent = document.getElementById('pollModalContent');
                
                modal.style.display = 'block';
                modalLoading.style.display = 'block';
                modalContent.style.display = 'none';
                
                // Fazer requisi√ß√£o
                const result = await apiRequest(`/poll/getChatPolls/${sessionId}`, 'POST', {
                    chatId: formattedChatId,
                    limit: 50
                });
                
                if (result.success) {
                    displayChatPolls(result.polls, formattedChatId);
                    modalLoading.style.display = 'none';
                    modalContent.style.display = 'block';
                } else {
                    alert(`‚ùå Erro ao obter enquetes: ${result.error}`);
                    modal.style.display = 'none';
                }
            } catch (error) {
                console.error('Erro ao obter enquetes:', error);
                alert(`‚ùå Erro ao obter enquetes: ${error.message}`);
                document.getElementById('pollModal').style.display = 'none';
            }
        }

        // Exibir enquetes do chat
        function displayChatPolls(polls, chatId) {
            const pollsList = document.getElementById('pollsList');
            const modalTitle = document.getElementById('pollModalTitle');
            
            modalTitle.textContent = `üìä Enquetes do Chat (${chatId}) - Total: ${polls.length}`;
            
            if (polls.length === 0) {
                pollsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #94a3b8;">
                        üì≠ Nenhuma enquete encontrada neste chat
                    </div>
                `;
                return;
            }
            
            pollsList.innerHTML = polls.map(poll => {
                const optionsHtml = poll.votes.map(vote => `
                    <div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                        <div style="font-weight: bold; color: #60a5fa;">üìä ${vote.option}</div>
                        <div style="color: #94a3b8; font-size: 0.9rem;">
                            ${vote.count} votos
                            ${vote.voters.length > 0 ? `
                                <div style="margin-top: 5px;">
                                    <strong>Votantes:</strong>
                                    ${vote.voters.map(voter => `
                                        <div style="font-size: 0.8rem; color: #cbd5e1; margin-left: 10px;">
                                            ‚Ä¢ ${voter.contactId} (${new Date(voter.timestamp * 1000).toLocaleString()})
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
                
                return `
                    <div style="margin: 20px 0; padding: 20px; background: #1a1a1c; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                            <h4 style="color: #fff; margin: 0;">üó≥Ô∏è ${poll.pollName}</h4>
                            <span style="color: #94a3b8; font-size: 0.9rem;">
                                ${new Date(poll.timestamp * 1000).toLocaleString()}
                            </span>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <span style="color: #94a3b8; font-size: 0.9rem;">
                                Total de votos: ${poll.totalVotes} | 
                                M√∫ltiplas respostas: ${poll.allowMultipleAnswers ? 'Sim' : 'N√£o'} |
                                ID: <code style="background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 4px;">${poll.messageId}</code>
                            </span>
                        </div>
                        
                        <div>
                            ${optionsHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Mostrar modal para buscar votos por ID
        function showPollVotesModal() {
            document.getElementById('pollVotesModal').style.display = 'block';
        }

        // Obter votos de uma enquete espec√≠fica por ID
        async function getPollVotes() {
            const sessionId = document.getElementById('pollVoteSessionId').value.trim();
            const messageId = document.getElementById('pollVoteMessageId').value.trim();
            
            if (!sessionId || !messageId) {
                alert('Por favor, preencha o ID da sess√£o e o ID da mensagem');
                return;
            }

            try {
                const result = await apiRequest(`/poll/getVotes/${sessionId}`, 'POST', {
                    messageId: messageId
                });
                
                const resultDiv = document.getElementById('pollVotesResult');
                
                if (result.success) {
                    const poll = result.poll;
                    const optionsHtml = poll.votes.map(vote => `
                        <div style="margin: 15px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <div style="font-weight: bold; color: #60a5fa; margin-bottom: 10px;">
                                üìä ${vote.option} (${vote.votes.length} votos)
                            </div>
                            ${vote.votes.map(v => `
                                <div style="margin: 5px 0; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px; font-size: 0.9rem;">
                                    <strong style="color: #cbd5e1;">${v.contactId}</strong>
                                    <div style="color: #94a3b8; font-size: 0.8rem;">
                                        ${new Date(v.timestamp * 1000).toLocaleString()}
                                        ${v.selectedOptions ? ` - Op√ß√µes: ${v.selectedOptions.join(', ')}` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `).join('');
                    
                    resultDiv.innerHTML = `
                        <div style="background: #1a1a1c; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); padding: 20px;">
                            <h4 style="color: #fff; margin-bottom: 15px;">üó≥Ô∏è ${poll.pollName}</h4>
                            <div style="margin-bottom: 15px; color: #94a3b8; font-size: 0.9rem;">
                                Total de votos: ${poll.totalVotes} | 
                                M√∫ltiplas respostas: ${poll.allowMultipleAnswers ? 'Sim' : 'N√£o'}
                            </div>
                            ${optionsHtml}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div style="color: #ef4444; padding: 15px; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                            ‚ùå Erro: ${result.error}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao obter votos:', error);
                document.getElementById('pollVotesResult').innerHTML = `
                    <div style="color: #ef4444; padding: 15px; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                        ‚ùå Erro: ${error.message}
                    </div>
                `;
            }
        }

        // Fechar modal ao clicar fora dele
        window.onclick = function(event) {
            const modal = document.getElementById('sessionInfoModal');
            if (modal && event.target === modal) {
                closeModal();
            }
        }

        // =====================================
        // FUN√á√ïES PARA GERENCIAR VIEW ONCE
        // =====================================

        // Obter m√≠dia View Once de um chat
        async function getViewOnceMedia() {
            const sessionId = document.getElementById('viewOnceSessionId').value.trim();
            const chatId = document.getElementById('viewOnceChatId').value.trim();
            
            if (!sessionId || !chatId) {
                alert('Por favor, preencha o ID da sess√£o e o Chat ID');
                return;
            }

            // Formatar chatId se necess√°rio
            let formattedChatId = chatId;
            if (!chatId.includes('@')) {
                formattedChatId = chatId + '@c.us';
            }

            try {
                const result = await apiRequest(`/viewonce/getMedia/${sessionId}`, 'POST', {
                    chatId: formattedChatId,
                    limit: 50,
                    includeExpired: false
                });
                
                if (result.success) {
                    displayViewOnceMedia(result.data);
                    document.getElementById('viewOnceMediaModal').style.display = 'block';
                } else {
                    alert(`‚ùå Erro ao obter m√≠dia View Once: ${result.error}`);
                }
            } catch (error) {
                console.error('Erro ao obter m√≠dia View Once:', error);
                alert(`‚ùå Erro ao obter m√≠dia View Once: ${error.message}`);
            }
        }

        // Exibir m√≠dia View Once no modal
        function displayViewOnceMedia(data) {
            const container = document.getElementById('viewOnceMediaResult');
            
            if (!data.messages || data.messages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #94a3b8;">
                        üëÅÔ∏è Nenhuma m√≠dia View Once encontrada neste chat
                        <p style="font-size: 0.9rem; margin-top: 10px;">
                            M√≠dia View Once pode ter expirado ou j√° foi visualizada
                        </p>
                    </div>
                `;
                return;
            }

            const messagesHtml = data.messages.map(message => `
                <div style="margin: 20px 0; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="color: #fff; margin: 0;">
                            ${message.type === 'image' ? 'üñºÔ∏è' : message.type === 'video' ? 'üé•' : 'üìé'} 
                            ${message.type.toUpperCase()}
                        </h4>
                        <span style="color: ${message.canDownload ? '#10b981' : '#ef4444'}; font-size: 0.9rem;">
                            ${message.canDownload ? '‚úÖ Dispon√≠vel' : '‚ùå Expirado/Visto'}
                        </span>
                    </div>
                    
                    <div style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 15px;">
                        üìÖ ${new Date(message.timestamp * 1000).toLocaleString()}<br>
                        üë§ ${message.fromMe ? 'Voc√™' : message.from}<br>
                        üí¨ ${message.caption || 'Sem legenda'}<br>
                        üìÅ ${message.mimetype} (${formatFileSize(message.filesize || 0)})<br>
                        üÜî <code style="background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 4px;">${message.id}</code>
                    </div>
                    
                    ${message.canDownload ? `
                        <button onclick="downloadSpecificViewOnce('${message.id}', '${data.chatId}', '${document.getElementById('viewOnceSessionId').value}')" 
                                style="background: #10b981; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;">
                            üíæ Baixar M√≠dia
                        </button>
                    ` : `
                        <button onclick="downloadSpecificViewOnce('${message.id}', '${data.chatId}', '${document.getElementById('viewOnceSessionId').value}', true)" 
                                style="background: #f59e0b; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;">
                            üíæ Tentar Baixar (For√ßado)
                        </button>
                    `}
                </div>
            `).join('');
            
            container.innerHTML = `
                <div style="background: #1a1a1c; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); padding: 20px;">
                    <h3 style="color: #fff; margin-bottom: 15px;">üëÅÔ∏è M√≠dia View Once Encontrada</h3>
                    <div style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 20px;">
                        üí¨ Chat: <code>${data.chatId}</code><br>
                        üìä Total encontrado: ${data.totalFound} | Exibindo: ${data.returned}
                    </div>
                    ${messagesHtml}
                </div>
            `;
        }

        // Obter estat√≠sticas View Once
        async function getViewOnceStats() {
            const sessionId = document.getElementById('viewOnceSessionId').value.trim();
            const chatId = document.getElementById('viewOnceChatId').value.trim();
            
            if (!sessionId || !chatId) {
                alert('Por favor, preencha o ID da sess√£o e o Chat ID');
                return;
            }

            let formattedChatId = chatId;
            if (!chatId.includes('@')) {
                formattedChatId = chatId + '@c.us';
            }

            try {
                const result = await apiRequest(`/viewonce/getStats/${sessionId}`, 'POST', {
                    chatId: formattedChatId,
                    days: 30
                });
                
                if (result.success) {
                    displayViewOnceStats(result.data);
                    document.getElementById('viewOnceStatsModal').style.display = 'block';
                } else {
                    alert(`‚ùå Erro ao obter estat√≠sticas: ${result.error}`);
                }
            } catch (error) {
                console.error('Erro ao obter estat√≠sticas:', error);
                alert(`‚ùå Erro ao obter estat√≠sticas: ${error.message}`);
            }
        }

        // Exibir estat√≠sticas View Once
        function displayViewOnceStats(data) {
            const container = document.getElementById('viewOnceStatsResult');
            const stats = data.stats;
            
            // Converter estat√≠sticas por data em gr√°fico visual simples
            const dateEntries = Object.entries(stats.byDate || {}).sort();
            const maxCount = Math.max(...Object.values(stats.byDate || {}), 1);
            
            const dateChartHtml = dateEntries.map(([date, count]) => {
                const percentage = (count / maxCount) * 100;
                return `
                    <div style="display: flex; align-items: center; margin: 5px 0;">
                        <span style="min-width: 80px; font-size: 0.8rem; color: #94a3b8;">${date.substring(5)}</span>
                        <div style="flex: 1; background: rgba(255,255,255,0.1); height: 15px; border-radius: 7px; margin: 0 10px; overflow: hidden;">
                            <div style="width: ${percentage}%; height: 100%; background: linear-gradient(90deg, #3b82f6, #60a5fa); border-radius: 7px;"></div>
                        </div>
                        <span style="min-width: 20px; font-size: 0.8rem; color: #60a5fa;">${count}</span>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div style="background: #1a1a1c; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); padding: 20px;">
                    <h3 style="color: #fff; margin-bottom: 15px;">üìä Estat√≠sticas View Once (${data.periodDays} dias)</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <div style="text-align: center; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
                            <div style="font-size: 1.5rem; color: #3b82f6; font-weight: bold;">${stats.viewOnceMessages}</div>
                            <div style="color: #94a3b8; font-size: 0.8rem;">View Once</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                            <div style="font-size: 1.5rem; color: #10b981; font-weight: bold;">${stats.images}</div>
                            <div style="color: #94a3b8; font-size: 0.8rem;">Imagens</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(245, 158, 11, 0.1); border-radius: 8px;">
                            <div style="font-size: 1.5rem; color: #f59e0b; font-weight: bold;">${stats.videos}</div>
                            <div style="color: #94a3b8; font-size: 0.8rem;">V√≠deos</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #fff; margin-bottom: 10px;">üìà Atividade por Data</h4>
                        <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px;">
                            ${dateChartHtml || '<div style="color: #94a3b8; text-align: center;">Nenhuma atividade no per√≠odo</div>'}
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h4 style="color: #fff; margin-bottom: 10px;">üîç Status</h4>
                            <div style="color: #94a3b8; line-height: 1.6;">
                                Visualizados: <span style="color: #ef4444;">${stats.viewed}</span><br>
                                N√£o visualizados: <span style="color: #10b981;">${stats.unviewed}</span><br>
                                De mim: <span style="color: #60a5fa;">${stats.fromMe}</span><br>
                                De outros: <span style="color: #f59e0b;">${stats.fromOthers}</span>
                            </div>
                        </div>
                        <div>
                            <h4 style="color: #fff; margin-bottom: 10px;">üìä Resumo</h4>
                            <div style="color: #94a3b8; line-height: 1.6;">
                                Total mensagens: ${stats.totalMessages}<br>
                                % View Once: ${stats.totalMessages > 0 ? ((stats.viewOnceMessages / stats.totalMessages) * 100).toFixed(1) : 0}%<br>
                                Per√≠odo: ${data.periodDays} dias<br>
                                Chat: <code style="font-size: 0.7rem;">${data.chatId}</code>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Obter chats com View Once
        async function getChatsWithViewOnce() {
            const sessionId = document.getElementById('viewOnceSessionId').value.trim();
            
            if (!sessionId) {
                alert('Por favor, preencha o ID da sess√£o');
                return;
            }

            try {
                const result = await apiRequest(`/viewonce/getChats/${sessionId}`, 'POST', {
                    limit: 50
                });
                
                if (result.success) {
                    displayChatsWithViewOnce(result.data);
                    document.getElementById('viewOnceChatsModal').style.display = 'block';
                } else {
                    alert(`‚ùå Erro ao obter chats: ${result.error}`);
                }
            } catch (error) {
                console.error('Erro ao obter chats:', error);
                alert(`‚ùå Erro ao obter chats: ${error.message}`);
            }
        }

        // Exibir chats com View Once
        function displayChatsWithViewOnce(data) {
            const container = document.getElementById('viewOnceChatsResult');
            
            if (!data.chats || data.chats.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #94a3b8;">
                        üí¨ Nenhum chat com m√≠dia View Once encontrado
                        <p style="font-size: 0.9rem; margin-top: 10px;">
                            Verifique ${data.totalChatsChecked} chats
                        </p>
                    </div>
                `;
                return;
            }

            const chatsHtml = data.chats.map(chat => `
                <div style="margin: 15px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; cursor: pointer;"
                     onclick="selectChatForViewOnce('${chat.chatId}', '${chat.name}')">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="color: #fff; margin: 0; margin-bottom: 5px;">
                                ${chat.isGroup ? 'üë•' : 'üë§'} ${chat.name}
                            </h4>
                            <div style="color: #94a3b8; font-size: 0.9rem;">
                                üÜî ${chat.chatId}<br>
                                üìÖ √öltima atividade: ${new Date(chat.lastActivity * 1000).toLocaleDateString()}
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.2rem; color: #3b82f6; font-weight: bold;">${chat.viewOnceCount}</div>
                            <div style="color: #94a3b8; font-size: 0.8rem;">View Once</div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = `
                <div style="background: #1a1a1c; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); padding: 20px;">
                    <h3 style="color: #fff; margin-bottom: 15px;">üí¨ Chats com View Once</h3>
                    <div style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 20px;">
                        üìä ${data.chatsWithViewOnce} de ${data.totalChatsChecked} chats verificados t√™m m√≠dia View Once
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${chatsHtml}
                    </div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); color: #94a3b8; font-size: 0.8rem;">
                        üí° Clique em um chat para selecion√°-lo nos campos de entrada
                    </div>
                </div>
            `;
        }

        // Selecionar chat para View Once
        function selectChatForViewOnce(chatId, chatName) {
            document.getElementById('viewOnceChatId').value = chatId;
            document.getElementById('viewOnceChatsModal').style.display = 'none';
            alert(`‚úÖ Chat selecionado: ${chatName}`);
        }

        // Mostrar modal para baixar View Once
        function showDownloadViewOnceModal() {
            document.getElementById('downloadViewOnceModal').style.display = 'block';
        }

        // Baixar m√≠dia View Once espec√≠fica
        async function downloadSpecificViewOnce(messageId, chatId, sessionId, force = false) {
            try {
                const result = await apiRequest(`/viewonce/download/${sessionId}`, 'POST', {
                    messageId: messageId,
                    chatId: chatId,
                    force: force
                });
                
                if (result.success) {
                    displayDownloadedMedia(result.data);
                } else {
                    alert(`‚ùå Erro ao baixar m√≠dia: ${result.error}`);
                }
            } catch (error) {
                console.error('Erro ao baixar m√≠dia:', error);
                alert(`‚ùå Erro ao baixar m√≠dia: ${error.message}`);
            }
        }

        // Baixar m√≠dia View Once do modal
        async function downloadViewOnceMedia() {
            const sessionId = document.getElementById('downloadViewOnceSessionId').value.trim();
            const chatId = document.getElementById('downloadViewOnceChatId').value.trim();
            const messageId = document.getElementById('downloadViewOnceMessageId').value.trim();
            const force = document.getElementById('forceDownload').checked;
            
            if (!sessionId || !chatId || !messageId) {
                alert('Por favor, preencha todos os campos obrigat√≥rios');
                return;
            }

            let formattedChatId = chatId;
            if (!chatId.includes('@')) {
                formattedChatId = chatId + '@c.us';
            }

            await downloadSpecificViewOnce(messageId, formattedChatId, sessionId, force);
        }

        // Exibir m√≠dia baixada
        function displayDownloadedMedia(data) {
            const container = document.getElementById('downloadViewOnceResult');
            const metadata = data.metadata;
            const media = data.media;
            
            // Criar URL para visualiza√ß√£o
            const mediaUrl = `data:${media.mimetype};base64,${media.data}`;
            
            let mediaPreview = '';
            if (metadata.type === 'image') {
                mediaPreview = `<img src="${mediaUrl}" style="max-width: 100%; max-height: 300px; border-radius: 8px;" alt="View Once Image">`;
            } else if (metadata.type === 'video') {
                mediaPreview = `
                    <video controls style="max-width: 100%; max-height: 300px; border-radius: 8px;">
                        <source src="${mediaUrl}" type="${media.mimetype}">
                        Seu navegador n√£o suporta o elemento de v√≠deo.
                    </video>
                `;
            } else {
                mediaPreview = `
                    <div style="padding: 40px; text-align: center; background: rgba(255,255,255,0.05); border-radius: 8px;">
                        üìé Arquivo: ${media.filename}<br>
                        <small>Tipo: ${media.mimetype}</small>
                    </div>
                `;
            }

            container.innerHTML = `
                <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); padding: 20px; border-radius: 8px;">
                    <h4 style="color: #10b981; margin: 0 0 15px 0;">‚úÖ M√≠dia baixada com sucesso!</h4>
                    
                    <div style="margin-bottom: 20px;">
                        ${mediaPreview}
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h5 style="color: #fff; margin: 0 0 10px 0;">üìã Informa√ß√µes:</h5>
                        <div style="color: #94a3b8; font-size: 0.9rem; line-height: 1.6;">
                            üìÖ Data: ${new Date(metadata.timestamp * 1000).toLocaleString()}<br>
                            üë§ De: ${metadata.fromMe ? 'Voc√™' : metadata.from}<br>
                            üè∑Ô∏è Tipo: ${metadata.type}<br>
                            üìÅ Arquivo: ${media.filename}<br>
                            üîß MIME: ${media.mimetype}<br>
                            üìä Tamanho: ${formatFileSize(media.filesize)}<br>
                            ‚è∞ Baixado em: ${new Date(metadata.downloadedAt).toLocaleString()}
                        </div>
                    </div>
                    
                    <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); padding: 10px; border-radius: 6px;">
                        <div style="color: #ef4444; font-size: 0.9rem;">
                            ‚ö†Ô∏è ${metadata.warning}
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <a href="${mediaUrl}" download="${media.filename}" 
                           style="background: #3b82f6; color: white; padding: 10px 15px; border-radius: 6px; text-decoration: none; display: inline-block;">
                            üíæ Salvar Arquivo
                        </a>
                    </div>
                </div>
            `;
        }

        // Fun√ß√£o utilit√°ria para formatar tamanho de arquivo
        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            checkApiStatus();
            loadSessions();
            
            // Verificar status da API a cada 60 segundos (reduzido de 30s)
            setInterval(checkApiStatus, 60000);
            
            // Atualizar lista de sess√µes a cada 60 segundos (aumentado de 10s para reduzir chamadas)
            // DESCOMENTE A LINHA ABAIXO SE QUISER AUTO-REFRESH
            // setInterval(loadSessions, 60000);
        });
    </script>
</body>
</html>